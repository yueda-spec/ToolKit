<!DOCTYPE html>
<html lang="ja">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-KD1SGEE7RH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KD1SGEE7RH');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>計算ツールキット</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        /* 電卓モード用のフォント指定 */
        #simple-calculator-container {
            font-family: 'Roboto Mono', monospace; 
        }
        /* contenteditableのデフォルトアウトラインを無効化 */
        [contenteditable]:focus {
            outline: none;
        }
        /* 数字入力欄の矢印を非表示 */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* --- エディタ（ラダー）形式用のスタイル --- */
        .ladder-container {
            position: relative;
            margin-left: 130px; /* 左側の時刻エリア */
            border-left: 2px solid #000; /* メインの縦線 */
            min-height: auto;
            padding-bottom: 0;
            overflow: visible;
        }

        .ladder-row {
            position: relative;
            border-top: 1px solid #000;
            min-height: 80px; 
            display: flex;
            align-items: stretch; 
            padding: 0; 
            background-color: #fff;
            transition: background-color 0.2s;
            border-radius: 0;
            margin-bottom: 0;
            z-index: 1;
        }
        /* 最後の行だけ下線を引く */
        .ladder-row:last-child {
            border-bottom: 1px solid #000;
        }

        .dark .ladder-row {
            background-color: #1f2937;
            border-color: #4b5563;
        }
        
        .ladder-row.dragging {
            opacity: 0.5;
            background-color: #eef2ff;
            border: 2px dashed #6366f1;
            z-index: 50;
        }

        /* --- 左側の時刻エリア --- */
        .ladder-time-box {
            position: absolute;
            left: -140px;
            top: 0;
            width: 130px;
            height: 100%;
            /* pointer-events: none を削除して、中の入力欄を触れるようにする */
            pointer-events: none; 
        }
        
        /* メイン時刻入力欄 (IN) */
        .time-input-display {
            position: absolute;
            right: 10px; 
            top: 0;      
            transform: translateY(-50%);
            
            pointer-events: auto;
            font-family: 'Roboto Mono', monospace;
            font-weight: bold;
            font-size: 14px;
            text-align: right;
            width: 120px;
            height: 26px;
            
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 0 5px;
            color: #374151;
            ime-mode: disabled; 
            z-index: 10;
        }
        .time-input-display:focus {
            border-color: #6366f1;
            outline: 2px solid #e0e7ff;
            z-index: 20;
            color: #000;
        }
        .dark .time-input-display { 
            background: #374151; 
            border-color: #4b5563; 
            color: #e5e7eb; 
        }

        /* --- 提供ベース（TB）時刻グループ（左エリア内） --- */
        .tb-time-group {
            position: absolute;
            right: 0; /* 右寄せ */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: center;
            gap: 2px;
            pointer-events: none;
            padding-right: 10px;
            /* 入力欄の高さ(30px)に合わせるための基準 */
            height: 30px; 
        }

        /* 位置合わせクラス（TB入力欄と同期） */
        .tb-time-group.pos-head {
            top: 12px; /* 上端マージンと一致 */
            bottom: auto;
        }
        .tb-time-group.pos-middle {
            top: 50%;
            transform: translateY(-50%);
        }
        .tb-time-group.pos-tail {
            top: auto;
            bottom: 12px; /* 下端マージンと一致 */
        }

        .tb-time-row-inner {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            position: relative;
            width: 100%;
        }

        /* TB時刻入力欄 */
        .tb-time-input {
            pointer-events: auto;
            font-family: 'Roboto Mono', monospace;
            font-size: 11px;
            color: #059669; 
            background: #fff;
            border: 1px solid transparent;
            border-radius: 3px;
            padding: 0 2px;
            width: 80px;
            text-align: right;
            z-index: 2;
            ime-mode: disabled;
        }
        .tb-time-input:focus {
            border-color: #059669;
            outline: none;
            background-color: #ecfdf5;
            color: #000;
        }
        .dark .tb-time-input { color: #34d399; background: #1f2937; }
        .dark .tb-time-input:focus { background-color: #064e3b; }

        

        /* --- 帯（バー） --- */
        .visual-bar-container {
            width: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
            margin-left: 2px;
            position: relative;
        }

        .visual-bar {
            width: 15px;
            flex-grow: 1; 
            background-color: #cbd5e1;
            border: 1px solid #94a3b8;
            border-top: none;
            border-bottom: none;
            margin-top: -1px;
            margin-bottom: -1px;
            z-index: 2; 
            position: relative;
        }
        .visual-bar.is-cm { display: none; }
        .visual-bar.hidden { display: none; }

        /* --- 中央のコンテンツエリア --- */
        .ladder-content {
            flex: 1;
            display: flex;
            flex-direction: row; 
            padding-left: 5px; 
            height: auto; 
            min-height: 80px;
        }
        
        .content-lane-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; 
            padding-top: 12px;
            padding-bottom: 12px;
            padding-right: 10px;
        }

        .content-lane-sub {
            width: auto;
            min-width: 200px; 
            display: flex;
            flex-direction: column;
            height: 100%; 
            padding-right: 10px;
            position: relative;
        }

        .content-row-main {
            width: 100%;
            height: 30px;
        }

        .content-input {
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            border: 1px solid transparent;
            background: transparent;
            padding: 4px;
            border-radius: 4px;
        }
        .content-input:hover, .content-input:focus {
            border-color: #ccc;
            background-color: #f9fafb;
        }
        .dark .content-input { color: white; }
        .dark .content-input:hover, .dark .content-input:focus { background-color: #374151; border-color: #6b7280; }

        /* --- 提供ベース（TB） --- */
        .tb-wrapper {
            position: relative; 
            display: flex;
            align-items: center;
            min-height: 30px;
            width: 100%;
            margin-top: 5px; 
            transition: margin 0.3s ease; 
        }
        .tb-wrapper.pos-head { margin-top: 12px; margin-bottom: auto; }
        .tb-wrapper.pos-middle { margin-top: auto; margin-bottom: auto; }
        .tb-wrapper.pos-tail { margin-top: auto; margin-bottom: 12px; }

        .tb-input-row {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #374151;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
            width: fit-content;
            border: 1px solid #e5e7eb;
            white-space: nowrap;
        }
        .dark .tb-input-row { color: #e5e7eb; background: #374151; border-color: #4b5563; }
        .tb-label { font-weight: bold; margin-right: 4px; white-space: nowrap; }
        
        .tb-add-btn {
            font-size: 11px;
            color: #6b7280;
            background: #f9fafb;
            border: 1px dashed #d1d5db;
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            width: fit-content;
            white-space: nowrap;
            margin-top: 12px; 
        }
        .tb-add-btn:hover { background: #f3f4f6; color: #4b5563; border-color: #9ca3af; }
        .dark .tb-add-btn { background: #374151; border-color: #4b5563; color: #9ca3af; }

        /* --- 右側の尺＆操作エリア --- */
        .ladder-duration-box {
            width: 160px; 
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            padding: 12px 10px 10px 0;
        }
        .duration-input-group {
            display: flex;
            align-items: center;
            gap: 2px;
            font-family: 'Roboto Mono', monospace;
            height: 30px;
        }
        .dur-input {
            width: 3rem;
            text-align: center;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 2px;
        }
        .dark .dur-input {
            background-color: #374151;
            border-color: #6b7280;
            color: white;
        }

        /* 操作ボタン */
        .row-controls {
            display: flex;
            gap: 5px;
            margin-top: 8px;
            opacity: 0.2;
            transition: opacity 0.2s;
        }
        .ladder-row:hover .row-controls { opacity: 1; }
        .drag-handle { cursor: grab; }
        
        .toggle-bar-btn {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .toggle-bar-btn.active {
            background-color: #d1fae5; color: #065f46; border-color: #34d399;
        }
        .toggle-bar-btn.inactive {
            background-color: #f3f4f6; color: #6b7280; border-color: #d1d5db;
        }
        .dark .toggle-bar-btn.active { background-color: #064e3b; color: #a7f3d0; }
        .dark .toggle-bar-btn.inactive { background-color: #374151; color: #9ca3af; border-color: #4b5563; }

        /* --- 終了時刻エリア --- */
        .ladder-bottom-area {
            position: relative;
            height: 0;
            margin-left: 130px; 
            border: none;
            z-index: 10;
        }
        .end-time-input {
            position: absolute;
            left: -140px;
            top: 0; 
            transform: translateY(-50%); 
            
            width: 120px;
            text-align: right;
            font-family: 'Roboto Mono', monospace;
            font-weight: bold;
            font-size: 14px;
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 0 5px;
            color: #374151;
            cursor: text;
            ime-mode: disabled;
            pointer-events: auto;
            margin-right: 10px;
        }
        .end-time-input:focus {
            border-color: #6366f1;
            outline: 2px solid #e0e7ff;
            color: #000;
        }
        .dark .end-time-input { background: #374151; border-color: #4b5563; color: #e5e7eb; }

        /* --- 印刷用 (PDF出力) --- */
        @media print {
            @page { margin: 15mm; size: A4 portrait; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; background: white; }
            body > *:not(#app-container) { display: none; }
            header, .border-b, footer, .no-print { display: none !important; }
            
            #app-container {
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                min-height: auto !important;
                display: block !important;
            }
            #app-container > div:not(#shaku-calculator-container) { display: none; }
            #shaku-calculator-container { display: block !important; }

            .ladder-container {
                margin-left: 140px;
                border-left-width: 2px;
                padding-bottom: 0;
            }
            .ladder-row {
                page-break-inside: avoid;
                border-top-color: #000;
                padding: 0;
                border-radius: 0;
                box-shadow: none;
            }
            .ladder-row:last-child {
                border-bottom: 1px solid #000;
            }
            
            .time-input-display, .content-input, .dur-input, .end-time-input, .tb-time-input, input, select {
                border: none !important;
                background: transparent !important;
                padding: 0 !important;
                outline: none !important;
                box-shadow: none !important;
            }
            .time-input-display, .end-time-input { text-align: right; font-weight: bold; color: black; }
            .content-input { font-weight: bold; color: black; }
            
            .row-controls, .add-btn-area, .print-only-hide, .tool-header, .tb-add-btn, .tb-remove-btn {
                display: none !important;
            }
            
            .tb-input-row {
                background: #f3f4f6 !important;
                border: none !important;
                color: black;
                padding: 2px 5px;
            }
            
            .ladder-bottom-area {
                border: none !important;
            }
            
            .visual-bar {
                border: 1px solid #666 !important;
                background-color: #ccc !important;
                border-top: none !important;
                border-bottom: none !important;
                margin-top: -1px !important;
                margin-bottom: -1px !important;
            }
            .visual-bar.is-cm { display: none !important; }
            .visual-bar.hidden { display: none !important; }
            
            .tb-time-input {
                color: black !important;
                font-weight: normal;
                background: white !important;
                text-align: right;
            }
            .tb-connector-line {
                background-color: #000 !important;
            }
        }
        
        #fireworks-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden; }
        .confetti { position: absolute; opacity: 0; animation: burst 2.5s ease-out forwards; }
        .confetti.circle { width: 10px; height: 10px; border-radius: 50%; }
        .confetti.rect { width: 8px; height: 15px; }
        @keyframes burst { 0% { transform: translate(-50%, -50%) rotate(0deg) scale(0); opacity: 1; } 100% { transform: translate(var(--x), calc(var(--y) + 200px)) rotate(720deg) scale(1); opacity: 0; } }
        
        #tc-result-timecode { background-color: rgba(234,179,8, 0.1); border-radius: 0.375rem; padding: 0.25rem 0.5rem; display: inline-block; }
        .dark #tc-result-timecode { background-color: rgba(251,191,36, 0.15); }
        .ar-active { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        .ar-inactive { background-color: white; color: #4b5563; border-color: #d1d5db; }
        .dark .ar-inactive { background-color: #374151; color: #d1d5db; border-color: #4b5563; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
        /* --- 提供ベース統合表示用の追加スタイル --- */

/* 1. 統合された時の時刻入力欄（緑色＋太字＋背景色） */
.time-input-display.is-tb-match,
.end-time-input.is-tb-match {
    color: #059669 !important;     /* 緑色の文字 */
    font-weight: 800 !important;   /* 太字 */
    background-color: #ecfdf5 !important; /* 薄い緑の背景 */
    border-color: #34d399 !important;     /* 薄い緑の枠線 */
    z-index: 30; /* 他の要素より手前に表示 */
}

/* ダークモード時の見た目 */
.dark .time-input-display.is-tb-match,
.dark .end-time-input.is-tb-match {
    color: #34d399 !important;
    background-color: #064e3b !important;
    border-color: #059669 !important;
}

/* 2. 「提供ベース」という文字ラベル（時刻の上に表示） */
.tb-label-overlay {
    position: absolute;
    right: 10px;        /* 右端を時刻入力欄に合わせる */
    top: -18px;         /* 時刻入力欄の真上に配置（調整値） */
    font-size: 10px;    /* 小さめの文字 */
    font-weight: bold;
    color: #059669;     /* 文字色：緑 */
    pointer-events: none; /* クリックの邪魔にならないようにする */
    white-space: nowrap;
    z-index: 31;
    text-shadow: 0 1px 0 rgba(255,255,255,0.8); /* 背景とかぶっても読めるように白縁取り */
}

.dark .tb-label-overlay {
    color: #34d399;
    text-shadow: 0 1px 0 rgba(0,0,0,0.8);
}

/* 印刷時の設定（カラー設定を維持） */
@media print {
    /* 1. 緑色の時刻入力欄 */
    .time-input-display.is-tb-match,
    .end-time-input.is-tb-match {
        color: #059669 !important;      /* 画面と同じ緑色 */
        background-color: #ecfdf5 !important; /* 背景の薄い緑も印刷 */
        border: 2px solid #059669 !important; /* 枠線も緑 */
        font-weight: 800 !important;
        -webkit-print-color-adjust: exact; /* 背景色を強制的に印刷させる設定 */
        print-color-adjust: exact;
    }
    
    /* 2. 「提供ベース」ラベル */
    .tb-label-overlay {
        color: #059669 !important; /* 緑色 */
        top: -16px;
        right: 0;
        font-size: 9px;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    /* 3. 浮いている提供ベースのラベル */
    .tb-float-label {
        color: #059669 !important;
        text-shadow: none !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
}
/* 浮遊している提供ベース開始時刻用のラベル */
.tb-float-label {
    position: absolute;
    right: 4px;         /* 入力欄の右端に合わせる */
    top: -11px;         /* 入力欄の上に表示 */
    font-size: 9px;
    color: #059669;
    font-weight: bold;
    pointer-events: none;
    white-space: nowrap;
    line-height: 1;
    text-shadow: 0 1px 0 rgba(255,255,255,0.8); /* 背景と重なっても読めるように */
    z-index: 5;
}
.dark .tb-float-label {
    color: #34d399;
    text-shadow: 0 1px 0 rgba(0,0,0,0.8);
}

@media print {
    .tb-float-label {
        color: black !important;
        text-shadow: none !important;
    }
}
/* --- コネクタライン（横線）の修正版設定 --- */
        
        /* 1. 共通設定（フロートTB用含む） */
        .tb-connector-line {
            /* ★長さ変更：隙間をあけるため短く (21px → 15px) */
            width: 15px; 
            height: 2px;
            background-color: #000; /* ★色変更：基本は黒色 */
            z-index: 50;
            flex-shrink: 0;
            
            /* ★スペース確保：左に5pxの隙間、右は縦線に届くように調整 */
            margin-left: 5px;  
            margin-right: -20px; /* Padding(10px)+Gap(10px)分を相殺 */
        }

        /* 2. 緑色の線（提供ベース用クラス） */
        .tb-connector-line.line-green {
            background-color: #059669;
        }

        /* 3. メイン時刻（左側）用の絶対配置設定 */
        .main-connector-line {
            position: absolute;
            /* ★長さ変更：縦線(-10px)にぴったり合わせる */
            right: -10px; 
            top: 0;
            transform: translateY(-50%);
            margin: 0; 
            /* 幅は共通設定の 15px が効くので、入力欄(right:10px)との間に5pxの隙間ができる */
        }

        /* 4. 印刷時の設定 */
        @media print {
            /* 統合された時刻（文字） */
            .time-input-display.is-tb-match,
            .end-time-input.is-tb-match {
                color: #059669 !important;
                border: none !important;
                background-color: transparent !important;
                font-weight: 800 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* 提供ベースラベル */
            .tb-label-overlay,
            .tb-float-label {
                color: #059669 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* ★色変更：印刷時も基本は黒、提供ベースだけ緑 */
            .tb-connector-line {
                background-color: #000 !important; /* 黒 */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .tb-connector-line.line-green {
                background-color: #059669 !important; /* 緑 */
            }
            
            /* 浮いている時刻文字 */
            .tb-time-input {
                color: #059669 !important;
                background-color: transparent !important;
                border: none !important;
            }
        }
    </style>
</head>
  <div class="absolute top-4 left-4 z-50">
    <a href="https://yueda-spec.github.io/Portal/" class="flex items-center gap-2 text-gray-500 hover:text-blue-600 transition-colors bg-white/80 backdrop-blur px-3 py-2 rounded-lg border border-gray-200 shadow-sm text-sm font-bold no-underline">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
        </svg>
        <span>ツール一覧</span>
    </a>
</div>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <div id="fireworks-container"></div>

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl min-h-screen flex flex-col">
        
        <header class="text-center mb-6">
            <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">計算ツールキット</h1>
            <p id="app-description" class="mt-2 text-sm sm:text-base text-gray-600 dark:text-gray-400">
                </p>
        </header>

        <div class="mb-6 flex flex-wrap justify-center border-b border-gray-200 dark:border-gray-700 overflow-x-auto whitespace-nowrap scrollbar-hide">
            <button id="mode-bitrate" class="mode-tab px-4 py-3 font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors whitespace-nowrap">
                ビットレート
            </button>
            <button id="mode-filesize" class="mode-tab px-4 py-3 font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors whitespace-nowrap">
                ファイルサイズ
            </button>
            <button id="mode-aspect" class="mode-tab px-4 py-3 font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors whitespace-nowrap">
                アスペクト比
            </button>
            <button id="mode-tc-conv" class="mode-tab px-4 py-3 font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors whitespace-nowrap">
                TC変換
            </button>
            <button id="mode-simple" class="mode-tab px-4 py-3 font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors whitespace-nowrap">
                尺電卓
            </button>
            <button id="mode-shaku" class="mode-tab px-4 py-3 font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors whitespace-nowrap">
                簡易Qシートエディタ
            </button>
        </div>

        <div id="bitrate-container" class="hidden">
            <div class="max-w-md mx-auto bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg">
                <div class="text-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">ビットレート計算</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">目標サイズからビットレートを算出</p>
                </div>
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">目標ファイルサイズ (MB)</label>
                    <input type="number" id="br-targetSize" inputmode="decimal" min="1" value="500" placeholder="例: 500" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                </div>
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">動画の尺（時間）</label>
                    <div class="grid grid-cols-3 gap-2 sm:gap-4">
                        <input type="number" id="br-hours" inputmode="numeric" min="0" placeholder="時間" class="p-3 text-center bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                        <input type="number" id="br-minutes" inputmode="numeric" min="0" placeholder="分" class="p-3 text-center bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                        <input type="number" id="br-seconds" inputmode="numeric" min="0" placeholder="秒" class="p-3 text-center bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                </div>
                <div class="mt-8">
                    <button id="br-calculateBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105">計算する</button>
                </div>
                <div id="br-result" class="mt-8 p-5 text-center rounded-lg hidden"></div>
                <div class="mt-4">
                     <button id="br-clearBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">入力をクリア</button>
                </div>
            </div>
        </div>

        <div id="filesize-container" class="hidden">
             <div class="max-w-md mx-auto bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg">
                <div class="text-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">ファイルサイズ計算</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">ビットレートからサイズを予測</p>
                </div>
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ビットレート (Mbps)</label>
                    <input type="number" id="fs-targetBitrate" inputmode="decimal" min="0.01" step="0.01" value="5" placeholder="例: 5" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                </div>
                <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">動画の尺（時間）</label>
                    <div class="grid grid-cols-3 gap-2 sm:gap-4">
                        <input type="number" id="fs-hours" inputmode="numeric" min="0" placeholder="時間" class="p-3 text-center bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                        <input type="number" id="fs-minutes" inputmode="numeric" min="0" placeholder="分" class="p-3 text-center bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                        <input type="number" id="fs-seconds" inputmode="numeric" min="0" placeholder="秒" class="p-3 text-center bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 transition">
                    </div>
                </div>
                <div class="mt-8">
                    <button id="fs-calculateBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105">計算する</button>
                </div>
                <div id="fs-result" class="mt-8 p-5 text-center rounded-lg hidden"></div>
                <div class="mt-4">
                     <button id="fs-clearBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">入力をクリア</button>
                </div>
            </div>
        </div>

        <div id="aspect-container" class="hidden">
             <div class="max-w-md mx-auto bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg">
                <div class="text-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">アスペクト比・解像度</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">解像度と比率の相互計算</p>
                </div>

                <div class="flex justify-center mb-6 gap-2">
                    <button id="ar-mode-calc-res" class="px-4 py-2 rounded-lg font-semibold text-sm border transition ar-active">解像度を計算</button>
                    <button id="ar-mode-calc-ratio" class="px-4 py-2 rounded-lg font-semibold text-sm border transition ar-inactive">比率を計算</button>
                </div>

                <div id="ar-form-res">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">基準とする辺</label>
                        <div class="flex gap-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="ar-base-side" value="width" checked class="w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                <span class="ml-2 text-gray-800 dark:text-gray-200">幅 (Width)</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="ar-base-side" value="height" class="w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                <span class="ml-2 text-gray-800 dark:text-gray-200">高さ (Height)</span>
                            </label>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">基準値 (px)</label>
                        <input type="number" id="ar-res-input-val" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="例: 1920">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">アスペクト比</label>
                        <select id="ar-res-select-ratio" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="16:9">16:9 (YouTube/TV)</option>
                            <option value="9:16">9:16 (TikTok/Shorts)</option>
                            <option value="4:3">4:3 (SD TV/iPad)</option>
                            <option value="1:1">1:1 (Instagram Square)</option>
                            <option value="custom">カスタム</option>
                        </select>
                        <div id="ar-res-custom-ratio-area" class="flex items-center gap-2 mt-2 hidden">
                            <input type="number" id="ar-res-custom-w" placeholder="W" class="w-full p-2 text-center bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                            <span class="font-bold text-gray-500">:</span>
                            <input type="number" id="ar-res-custom-h" placeholder="H" class="w-full p-2 text-center bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                        </div>
                    </div>
                    <button id="ar-btn-calc-res" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105">計算する</button>
                </div>
                 <div id="ar-form-ratio" class="hidden">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">解像度 (px)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="ar-ratio-w" placeholder="幅 (W)" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                            <span class="font-bold text-gray-500">x</span>
                            <input type="number" id="ar-ratio-h" placeholder="高さ (H)" class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                    </div>
                    <button id="ar-btn-calc-ratio" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105">比率を算出</button>
                </div>
                <div id="ar-result" class="mt-8 p-5 text-center rounded-lg hidden"></div>
                <div class="mt-4">
                     <button id="ar-clearBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">入力をクリア</button>
                </div>
            </div>
        </div>

        <div id="tc-conversion-container" class="hidden">
            <div class="max-w-md mx-auto bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-lg">
                <div class="text-center mb-6">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">タイムコード変換</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">異なるフレームレート間での変換</p>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">変換元タイムコード</label>
                    <div class="flex justify-center items-center gap-1 mb-3">
                        <input type="number" min="0" placeholder="HH" id="tc-source-h" class="w-1/4 p-2 text-center text-lg bg-gray-100 dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" inputmode="numeric">
                        <span class="font-bold text-xl text-gray-500 dark:text-gray-400">:</span>
                        <input type="number" min="0" max="59" placeholder="MM" id="tc-source-m" class="w-1/4 p-2 text-center text-lg bg-gray-100 dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" inputmode="numeric">
                        <span class="font-bold text-xl text-gray-500 dark:text-gray-400">:</span>
                        <input type="number" min="0" max="59" placeholder="SS" id="tc-source-s" class="w-1/4 p-2 text-center text-lg bg-gray-100 dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" inputmode="numeric">
                        <span id="tc-source-separator" class="font-bold text-xl text-gray-500 dark:text-gray-400">:</span>
                        <input type="number" min="0" placeholder="FF" id="tc-source-f" class="w-1/4 p-2 text-center text-lg bg-gray-100 dark:bg-gray-700 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" inputmode="numeric">
                    </div>
                    <select id="tc-source-format" class="w-full p-3 text-base bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <option value="29.97_ndf">29.97 fps NDF</option>
                        <option value="23.976_ndf">23.976 fps NDF (24p)</option>
                        <option value="29.97_df">29.97 fps DF</option>
                    </select>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">変換先フォーマット</label>
                    <select id="tc-target-format" class="w-full p-3 text-base bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        <option value="29.97_ndf">29.97 fps NDF</option>
                        <option value="23.976_ndf">23.976 fps NDF (24p)</option>
                        <option value="29.97_df">29.97 fps DF</option>
                    </select>
                </div>

                <div class="flex gap-3 mb-6">
                    <button id="tc-convert-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">変換</button>
                    <button id="tc-clear-btn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition">クリア</button>
                </div>

                <div id="tc-result-wrapper" class="bg-gray-50 dark:bg-gray-700 p-5 rounded-xl hidden">
                    <h2 id="tc-result-title" class="text-lg font-semibold text-gray-900 dark:text-white mb-2 text-center"></h2>
                    <div class="relative flex justify-center items-center mb-2">
                        <p id="tc-result-timecode" class="text-3xl sm:text-4xl font-bold tracking-wider text-green-700 dark:text-green-400"></p>
                        <button id="tc-copy-btn" class="absolute right-0 text-gray-400 hover:text-indigo-500 dark:hover:text-indigo-400 transition-colors ml-2" title="コピー">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                        </button>
                    </div>
                    <p id="tc-extra-info" class="text-center text-sm text-gray-600 dark:text-gray-300"></p>
                    <p id="tc-copy-feedback" class="text-center text-xs text-green-600 dark:text-green-400 mt-1 h-4"></p>
                </div>
            </div>
        </div>

        <div id="simple-calculator-container" class="hidden flex items-center justify-center antialiased flex-col">
             <div class="bg-white dark:bg-gray-800 w-full max-w-md p-6 rounded-3xl shadow-lg space-y-4">
                <div class="bg-gray-200 dark:bg-gray-900 p-4 rounded-xl shadow-inner">
                    <div id="calc-history" class="text-right text-lg font-mono font-medium text-gray-500 dark:text-gray-400 mb-2 overflow-x-auto whitespace-nowrap min-h-[1.75rem]" aria-label="計算式（編集可）"></div>
                    <div id="calc-display" class="text-right font-mono font-bold text-5xl md:text-6xl text-gray-800 dark:text-white tracking-tight leading-none select-none" style="font-variant-numeric: tabular-nums;">00:00:00</div>
                </div>
                <div class="flex items-center justify-between px-1">
                    <div id="edit-hint" class="text-xs text-gray-500 dark:text-gray-400 select-none">式の訂正：編集 → 適用（Enter）/ 取消（Esc）</div>
                    <div class="flex gap-2">
                        <button id="edit-cancel" class="hidden text-xs px-3 py-1 rounded-md text-gray-300 bg-gray-600 hover:bg-gray-500 dark:bg-gray-700 dark:hover:bg-gray-600 transition-colors">取消</button>
                        <button id="edit-toggle" class="text-xs px-3 py-1 rounded-md text-blue-800 bg-blue-200 hover:bg-blue-300 dark:text-blue-300 dark:bg-blue-900/50 dark:hover:bg-blue-900/80 transition-colors">編集</button>
                    </div>
                </div>
                <div id="edit-error" class="text-red-500 text-sm min-h-[1.25rem] px-1"></div>
                <div class="grid grid-cols-4 gap-3 md:gap-4">
                    <button class="h-16 md:h-20 text-2xl md:text-3xl font-semibold rounded-xl shadow-md transition-transform duration-100 active:scale-95 text-gray-800 dark:text-white bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600" data-num="7">7</button>
                    <button class="h-16 md:h-20 text-2xl md:text-3xl font-semibold rounded-xl shadow-md transition-transform duration-100 active:scale-95 text-gray-800 dark:text-white bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600" data-num="8">8</button>
                    <button class="h-16 md:h-20 text-2xl md:text-3xl font-semibold rounded-xl shadow-md transition-transform duration-100 active:scale-95 text-gray-800 dark:text-white bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600" data-num="9">9</button>
                    <button id="clear-btn" class="h-16 md:h-20 text-2xl md:text-3xl font-semibold rounded-xl shadow-md transition-transform duration-100 active:scale-95 text-white bg-rose-600 hover:bg-rose-500">C</button>
                    <button class="h-16 md:h-20 text-2xl md:text-3xl font-semibold rounded-xl shadow-md transition-transform duration-100 active:scale-95 text-gray-800 dark:text-white bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600" data-num="4">4</button>
                    <button class="h-16 md:h-20 text-2xl md:text-3xl font-semibold rounded-xl shadow-md transition-transform duration-100 active:scale-95 text-gray-800 dark:text-white bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600" data-num="5">5</button>
                    <button class="h-16 md:h-20 text-2xl md:text-3xl font-semibold rounded-xl shadow-md transition-transform duration-100 active:scale-95 text-gray-800 dark:text-white bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600" data-num="6">6</button>
                    <button id="backspace-btn" class="h-16 md:h-20 text-2xl md:text-3xl font-semibold rounded-xl shadow-md transition-transform duration-100 active:scale-95 text-white bg-amber-600 hover:bg-amber-500">←</button>
                    <button class="h-16 md:h-20 text-2xl md:text-3xl font-semibold rounded-xl shadow-md transition-transform duration-100 active:scale-95 text-gray-800 dark:text-white bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600" data-num="1">1</button>
                    <button class="h-16 md:h-20 text-2xl md:text-3xl font-semibold rounded-xl shadow-md transition-transform duration-100 active:scale-95 text-gray-800 dark:text-white bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600" data-num="2">2</button>
                    <button class="h-16 md:h-20 text-2xl md:text-3xl font-semibold rounded-xl shadow-md transition-transform duration-100 active:scale-95 text-gray-800 dark:text-white bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600" data-num="3">3</button>
                    <button class="h-16 md:h-20 text-2xl md:text-3xl font-semibold rounded-xl shadow-md transition-transform duration-100 active:scale-95 text-white bg-blue-600 hover:bg-blue-500" data-op="-">－</button>
                    <button class="col-span-2 h-16 md:h-20 text-2xl md:text-3xl font-semibold rounded-xl shadow-md transition-transform duration-100 active:scale-95 text-gray-800 dark:text-white bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600" data-num="0">0</button>
                    <button id="colon-btn" class="h-16 md:h-20 text-2xl md:text-3xl font-semibold rounded-xl shadow-md transition-transform duration-100 active:scale-95 text-gray-800 dark:text-white bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600">:</button>
                    <button class="h-16 md:h-20 text-2xl md:text-3xl font-semibold rounded-xl shadow-md transition-transform duration-100 active:scale-95 text-white bg-blue-600 hover:bg-blue-500" data-op="+">＋</button>
                    <div></div><div></div><div></div>
                    <button id="equal-btn" class="h-16 md:h-20 text-2xl md:text-3xl font-semibold rounded-xl shadow-md transition-transform duration-100 active:scale-95 text-white bg-emerald-500 hover:bg-emerald-400">＝</button>
                </div>
                <p class="text-center text-xs text-gray-500 dark:text-gray-400 mt-3 select-none">※テンキーの「.」で「:」を入力できます</p>
            </div>
        </div>

        <div id="shaku-calculator-container" class="hidden w-full max-w-5xl mx-auto">
            
            <div class="tool-header bg-white dark:bg-gray-800 p-4 rounded-xl shadow mb-6 flex flex-wrap items-center justify-between gap-4">
                <div class="flex-1 min-w-[200px]">
                    <label class="text-xs font-bold text-gray-500 dark:text-gray-400 block mb-1">作品タイトル (TITLE)</label>
                    <input type="text" id="editor-title" placeholder="番組名など" class="w-full text-lg font-bold bg-transparent border-b border-gray-300 dark:border-gray-600 focus:border-indigo-500 outline-none dark:text-white">
                </div>
                <div class="flex items-center gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500 dark:text-gray-400 block mb-1">開始TC (START)</label>
                        <input type="text" id="editor-start-tc" value="01:00:00" class="font-mono text-lg text-center w-32 bg-gray-100 dark:bg-gray-700 rounded px-2 py-1 dark:text-white border border-transparent focus:border-indigo-500">
                    </div>
                    <button id="editor-reset-btn" class="text-sm text-gray-500 hover:text-red-500 underline">全てリセット</button>
                </div>
            </div>

            <div id="ladder-editor" class="bg-white dark:bg-gray-900 p-8 min-h-[500px] rounded shadow-xl print:shadow-none print:p-0">
                
                <div class="print-only-header mb-4 hidden print:block">
                    <div class="font-bold text-xl mb-2"><span class="text-sm font-normal mr-2">TITLE:</span><span id="print-title-display"></span></div>
                    <div class="text-sm border-b-2 border-black mb-2 pb-1 flex justify-between">
                        <span>DATE: <span id="print-date-display"></span></span>
                        <span>PAGE: 1</span>
                    </div>
                </div>

                <div class="ladder-container" id="ladder-rows-container">
                    </div>
                
                

            </div>

            <div class="add-btn-area mt-8 text-center print:hidden">
                <button id="editor-add-row-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105 flex items-center gap-2 mx-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    項目を追加
                </button>
                
                <div class="mt-6 flex justify-center gap-4">
                    <button id="editor-print-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded shadow flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                        PDF保存 (印刷)
                    </button>
                </div>
            </div>

        </div>
        
        <footer class="mt-auto pt-12 pb-6 flex justify-center opacity-80 hover:opacity-100 transition-opacity">
           <img id="companyLogo" alt="Company Logo" style="width: 120px; display: block;">
        </footer>
        <script>
            fetch('logo.txt')
                .then(response => response.text())
                .then(data => {
                    const img = document.getElementById('companyLogo');
                    if(img) img.src = data;
                })
                .catch(error => console.error('Logo loading failed:', error));
        </script>

    </div>

    <div id="print-area" style="visibility: hidden;">
        <div class="q-sheet-wrapper">
            <div class="q-header">
                <div class="q-title-cell">
                    <div class="q-label">TITLE:</div>
                    <div class="q-title-text" id="print-title-val"></div>
                </div>
                <div class="q-meta-cell">
                    <div class="q-meta-row">
                        <span>DATE:</span>
                        <span id="print-date-val"></span>
                    </div>
                    <div class="q-meta-row">
                        <span>PAGE:</span>
                        <span>1 / 1</span>
                    </div>
                </div>
            </div>
            <table class="q-table">
                <thead>
                    <tr>
                        <th class="col-no">No</th>
                        <th class="col-content">項目 (CONTENT)</th>
                        <th class="col-dur">時間 (DUR)</th>
                        <th class="col-in">IN</th>
                        <th class="col-out">OUT</th>
                        <th class="col-remarks">備考</th>
                    </tr>
                </thead>
                <tbody id="print-table-body">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="qsheet-modal" class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none modal">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white dark:bg-gray-800 w-11/12 md:max-w-lg mx-auto rounded-lg shadow-2xl z-50">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b dark:border-gray-600">
                    <p class="text-2xl font-bold text-gray-800 dark:text-white">Qシート (PDF出力)</p>
                    <div class="modal-close cursor-pointer z-50 text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">
                        <svg class="fill-current text-black dark:text-white" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                            <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                        </svg>
                    </div>
                </div>

                <div class="my-6">
                    <div class="mb-4">
                        <label class="text-sm font-medium text-gray-700 dark:text-gray-300 block mb-1">作品タイトル</label>
                        <input type="text" id="qsheet-title-input" class="w-full p-3 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="番組名・タイトルを入力">
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div class="flex-1">
                            <label class="text-sm font-medium text-gray-700 dark:text-gray-300 block mb-1">基準開始TC</label>
                            <input type="text" id="qsheet-start-time" value="01:00:00" class="w-full p-3 text-center border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="HH:MM:SS">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end pt-2 gap-2">
                    <button class="modal-close px-4 py-3 bg-gray-300 dark:bg-gray-600 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 text-gray-800 dark:text-white transition font-medium">閉じる</button>
                    <button id="qsheet-print-btn" class="px-6 py-3 bg-blue-600 rounded-lg hover:bg-blue-700 text-white font-bold shadow-lg transition flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                        </svg>
                        PDF保存 (印刷)
                    </button>
                </div>
                <p class="text-right text-xs text-gray-500 dark:text-gray-400 mt-3">
                    ※「送信先」で「PDFとして保存」を選択してください。
                </p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 汎用要素の取得 ---
        const tabs = {
            bitrate: document.getElementById('mode-bitrate'),
            filesize: document.getElementById('mode-filesize'),
            aspect: document.getElementById('mode-aspect'),
            tc: document.getElementById('mode-tc-conv'),
            simple: document.getElementById('mode-simple'),
            shaku: document.getElementById('mode-shaku')
        };

        const containers = {
            bitrate: document.getElementById('bitrate-container'),
            filesize: document.getElementById('filesize-container'),
            aspect: document.getElementById('aspect-container'),
            tc: document.getElementById('tc-conversion-container'),
            simple: document.getElementById('simple-calculator-container'),
            shaku: document.getElementById('shaku-calculator-container')
        };

        const appDescription = document.getElementById('app-description');
        
        // --- モード切替ロジック ---
        function switchMode(modeName) {
            Object.values(containers).forEach(el => el.classList.add('hidden'));
            Object.values(tabs).forEach(el => {
                el.classList.remove('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
                el.classList.add('border-transparent', 'text-gray-500');
            });

            containers[modeName].classList.remove('hidden');
            tabs[modeName].classList.add('border-blue-500', 'text-blue-600', 'dark:text-blue-400');
            tabs[modeName].classList.remove('border-transparent', 'text-gray-500');

            switch(modeName) {
                case 'bitrate': appDescription.textContent = '目標ファイルサイズと時間からビットレートを計算します。'; break;
                case 'filesize': appDescription.textContent = 'ビットレートと時間からファイルサイズを計算します。'; break;
                case 'aspect': appDescription.textContent = '解像度とアスペクト比を相互に計算します。'; break;
                case 'tc': appDescription.textContent = '異なるフレームレートのタイムコードを相互に変換します。'; break;
                case 'simple': appDescription.textContent = 'タイムコード計算専用の電卓です。'; break;
                case 'shaku': appDescription.textContent = '尺の自動計算、提供ベース管理、PDF出力が出来ます。'; break;
            }
        }

        tabs.bitrate.addEventListener('click', () => switchMode('bitrate'));
        tabs.filesize.addEventListener('click', () => switchMode('filesize'));
        tabs.aspect.addEventListener('click', () => switchMode('aspect'));
        tabs.tc.addEventListener('click', () => switchMode('tc'));
        tabs.simple.addEventListener('click', () => switchMode('simple'));
        tabs.shaku.addEventListener('click', () => switchMode('shaku'));

        // --- 各機能の初期化 ---
        setupBitrateOnlyCalculator();
        setupFileSizeOnlyCalculator();
        setupAspectRatioCalculator();
        setupTimecodeConverter();
        setupSimpleCalculator();
        setupShakuCalculator();

        // --- デフォルトモード ---
        switchMode('bitrate');
    });

    // --- 共通ヘルパー ---
    function showError(el, msg) {
        el.classList.remove('hidden');
        el.classList.add('bg-red-100', 'dark:bg-red-800');
        el.innerHTML = `<p class="font-semibold text-red-800 dark:text-red-200">${msg}</p>`;
    }
    function showResult(el, val, label) {
        el.classList.remove('hidden');
        el.classList.add('bg-green-100', 'dark:bg-green-800');
        el.innerHTML = `<p class="text-sm text-green-800 dark:text-green-200">${label}</p><p class="text-3xl font-bold text-green-900 dark:text-white mt-1">${val}</p>`;
    }
    function formatFileSize(sizeInMB) {
        const unitStyle = '<span class="text-xl font-medium">'; const unitClose = '</span>';
        if (sizeInMB < 1) return `${(sizeInMB * 1024).toFixed(2)} ${unitStyle}KB${unitClose}`;
        else if (sizeInMB < 1024) return `${sizeInMB.toFixed(2)} ${unitStyle}MB${unitClose}`;
        else if (sizeInMB < 1024 * 1024) return `${(sizeInMB / 1024).toFixed(2)} ${unitStyle}GB${unitClose}`;
        else return `${(sizeInMB / (1024 * 1024)).toFixed(2)} ${unitStyle}TB${unitClose}`;
    }
    function autoCarryOver(hIn, mIn, sIn) {
        function carryM() { let h=parseInt(hIn.value)||0, m=parseInt(mIn.value)||0; if(m>=60){ h+=Math.floor(m/60); mIn.value=m%60; hIn.value=h; } }
        function carryS() { let m=parseInt(mIn.value)||0, s=parseInt(sIn.value)||0; if(s>=60){ m+=Math.floor(s/60); sIn.value=s%60; mIn.value=m; carryM(); } }
        mIn.addEventListener('blur', carryM); sIn.addEventListener('blur', carryS);
    }
    function setupEnterKey(inputs, btn) {
        inputs.forEach(input => { input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); btn.click(); } }); });
    }

    // =======================================================
    // ▼▼▼ 1-5. 各種計算機ロジック (省略なしで実装) ▼▼▼
    // =======================================================
    function setupBitrateOnlyCalculator() {
        const sizeInput=document.getElementById('br-targetSize'), hInput=document.getElementById('br-hours'), mInput=document.getElementById('br-minutes'), sInput=document.getElementById('br-seconds');
        const calcBtn=document.getElementById('br-calculateBtn'), resultDiv=document.getElementById('br-result'), clearBtn=document.getElementById('br-clearBtn');
        calcBtn.addEventListener('click', () => {
            const h=parseInt(hInput.value)||0, m=parseInt(mInput.value)||0, s=parseInt(sInput.value)||0, sizeMB=parseFloat(sizeInput.value)||0;
            resultDiv.classList.add('hidden'); resultDiv.className='mt-8 p-5 text-center rounded-lg hidden';
            if(h<0||m<0||s<0){ showError(resultDiv, '時間には負の値を入力できません。'); return; }
            const totalSeconds=(h*3600)+(m*60)+s;
            if(totalSeconds<=0){ showError(resultDiv, '有効な動画の尺を入力してください。'); return; }
            if(sizeMB<=0){ showError(resultDiv, 'ファイルサイズには0より大きい数値を入力してください。'); return; }
            const bitrateMbps=(sizeMB*8)/totalSeconds;
            showResult(resultDiv, `${bitrateMbps.toFixed(2)} <span class="text-xl font-medium">Mbps</span>`, '推奨ビットレート');
        });
        clearBtn.addEventListener('click', () => { sizeInput.value='500'; hInput.value=''; mInput.value=''; sInput.value=''; resultDiv.classList.add('hidden'); });
        autoCarryOver(hInput, mInput, sInput); setupEnterKey([sizeInput, hInput, mInput, sInput], calcBtn);
    }

    function setupFileSizeOnlyCalculator() {
        const bitrateInput=document.getElementById('fs-targetBitrate'), hInput=document.getElementById('fs-hours'), mInput=document.getElementById('fs-minutes'), sInput=document.getElementById('fs-seconds');
        const calcBtn=document.getElementById('fs-calculateBtn'), resultDiv=document.getElementById('fs-result'), clearBtn=document.getElementById('fs-clearBtn');
        calcBtn.addEventListener('click', () => {
            const h=parseInt(hInput.value)||0, m=parseInt(mInput.value)||0, s=parseInt(sInput.value)||0, bitrateMbps=parseFloat(bitrateInput.value)||0;
            resultDiv.classList.add('hidden'); resultDiv.className='mt-8 p-5 text-center rounded-lg hidden';
            if(h<0||m<0||s<0){ showError(resultDiv, '時間には負の値を入力できません。'); return; }
            const totalSeconds=(h*3600)+(m*60)+s;
            if(totalSeconds<=0){ showError(resultDiv, '有効な動画の尺を入力してください。'); return; }
            if(bitrateMbps<=0){ showError(resultDiv, 'ビットレートには0より大きい数値を入力してください。'); return; }
            const sizeMB=(bitrateMbps*totalSeconds)/8;
            showResult(resultDiv, formatFileSize(sizeMB), '予測ファイルサイズ');
        });
        clearBtn.addEventListener('click', () => { bitrateInput.value='5'; hInput.value=''; mInput.value=''; sInput.value=''; resultDiv.classList.add('hidden'); });
        autoCarryOver(hInput, mInput, sInput); setupEnterKey([bitrateInput, hInput, mInput, sInput], calcBtn);
    }

    function setupAspectRatioCalculator() {
        const modeResBtn = document.getElementById('ar-mode-calc-res'), modeRatioBtn = document.getElementById('ar-mode-calc-ratio'), formRes = document.getElementById('ar-form-res'), formRatio = document.getElementById('ar-form-ratio'), resultDiv = document.getElementById('ar-result'), clearBtn = document.getElementById('ar-clearBtn');
        function setMode(mode) {
            resultDiv.classList.add('hidden');
            if (mode === 'res') { modeResBtn.classList.replace('ar-inactive', 'ar-active'); modeRatioBtn.classList.replace('ar-active', 'ar-inactive'); formRes.classList.remove('hidden'); formRatio.classList.add('hidden'); } 
            else { modeRatioBtn.classList.replace('ar-inactive', 'ar-active'); modeResBtn.classList.replace('ar-active', 'ar-inactive'); formRatio.classList.remove('hidden'); formRes.classList.add('hidden'); }
        }
        modeResBtn.addEventListener('click', () => setMode('res')); modeRatioBtn.addEventListener('click', () => setMode('ratio'));
        const resInputVal=document.getElementById('ar-res-input-val'), resSelectRatio=document.getElementById('ar-res-select-ratio'), resCustomArea=document.getElementById('ar-res-custom-ratio-area'), resCustomW=document.getElementById('ar-res-custom-w'), resCustomH=document.getElementById('ar-res-custom-h'), resBtn=document.getElementById('ar-btn-calc-res'), radioBaseSide=document.getElementsByName('ar-base-side');
        resSelectRatio.addEventListener('change', () => { if (resSelectRatio.value === 'custom') resCustomArea.classList.remove('hidden'); else resCustomArea.classList.add('hidden'); });
        resBtn.addEventListener('click', () => {
            resultDiv.classList.add('hidden'); resultDiv.className='mt-8 p-5 text-center rounded-lg hidden';
            const val = parseFloat(resInputVal.value); if (!val || val <= 0) { showError(resultDiv, '正の数値を入力してください'); return; }
            let ratioW, ratioH; if (resSelectRatio.value === 'custom') { ratioW = parseFloat(resCustomW.value); ratioH = parseFloat(resCustomH.value); } else { const parts = resSelectRatio.value.split(':'); ratioW = parseFloat(parts[0]); ratioH = parseFloat(parts[1]); if(resSelectRatio.value === '2.35:1') { ratioW = 2.35; ratioH = 1; } }
            if (!ratioW || !ratioH || ratioW <= 0 || ratioH <= 0) { showError(resultDiv, '有効な比率を指定してください'); return; }
            let isWidthBase = true; for(let r of radioBaseSide) { if(r.checked && r.value === 'height') isWidthBase = false; }
            let w, h; if (isWidthBase) { w = val; h = (val * ratioH) / ratioW; showResult(resultDiv, `${Math.round(h)} <span class="text-xl font-medium">px</span>`, '高さ (Height)'); } else { h = val; w = (val * ratioW) / ratioH; showResult(resultDiv, `${Math.round(w)} <span class="text-xl font-medium">px</span>`, '幅 (Width)'); }
        });
        const ratioWInput=document.getElementById('ar-ratio-w'), ratioHInput=document.getElementById('ar-ratio-h'), ratioBtn=document.getElementById('ar-btn-calc-ratio');
        function gcd(a, b) { return b == 0 ? a : gcd(b, a % b); }
        ratioBtn.addEventListener('click', () => {
            resultDiv.classList.add('hidden'); resultDiv.className='mt-8 p-5 text-center rounded-lg hidden';
            const w = parseInt(ratioWInput.value), h = parseInt(ratioHInput.value);
            if (!w || !h || w <= 0 || h <= 0) { showError(resultDiv, '幅と高さを正の整数で入力してください'); return; }
            const divisor = gcd(w, h), rw = w / divisor, rh = h / divisor, decimal = (w / h).toFixed(3);
            showResult(resultDiv, `${rw}:${rh} <span class="text-lg text-gray-500 block mt-1">(${decimal}:1)</span>`, 'アスペクト比');
        });
        clearBtn.addEventListener('click', () => { resInputVal.value = ''; resCustomW.value = ''; resCustomH.value = ''; ratioWInput.value = ''; ratioHInput.value = ''; resultDiv.classList.add('hidden'); });
        setupEnterKey([resInputVal, resCustomW, resCustomH], resBtn); setupEnterKey([ratioWInput, ratioHInput], ratioBtn);
    }

    function setupTimecodeConverter() {
        const h_in=document.getElementById('tc-source-h'), m_in=document.getElementById('tc-source-m'), s_in=document.getElementById('tc-source-s'), f_in=document.getElementById('tc-source-f');
        const timeInputs=[h_in, m_in, s_in, f_in]; const sourceFormatSelect=document.getElementById('tc-source-format'), targetFormatSelect=document.getElementById('tc-target-format'), convertBtn=document.getElementById('tc-convert-btn'), clearBtn=document.getElementById('tc-clear-btn'), resultWrapper=document.getElementById('tc-result-wrapper'), resultTitle=document.getElementById('tc-result-title'), resultTimecode=document.getElementById('tc-result-timecode'), extraInfo=document.getElementById('tc-extra-info'), sourceSeparatorEl=document.getElementById('tc-source-separator'), copyBtn=document.getElementById('tc-copy-btn'), copyFeedback=document.getElementById('tc-copy-feedback');
        const formats={'29.97_ndf':{name:'29.97 fps NDF',timeBase:30,isDf:false,rate:30000/1001},'29.97_df':{name:'29.97 fps DF',timeBase:30,isDf:true,rate:30000/1001},'23.976_ndf':{name:'23.976 fps NDF (24p)',timeBase:24,isDf:false,rate:24000/1001}};
        const clamp=(val,min,max)=>Math.min(Math.max(val,min),max); const pad2=(n)=>String(n).padStart(2,'0');
        const formatInputOnBlur=(e)=>{ if(e.target.value!=='') e.target.value=pad2(parseInt(e.target.value,10)); };
        function updateSourceUI() { const format=formats[sourceFormatSelect.value]; sourceSeparatorEl.textContent=format.isDf?';':':'; f_in.max=format.timeBase-1; if(parseInt(f_in.value)>=format.timeBase) f_in.value=format.timeBase-1; }
        function saveSettings(){ const s={h:h_in.value,m:m_in.value,s:s_in.value,f:f_in.value,source:sourceFormatSelect.value,target:targetFormatSelect.value}; localStorage.setItem('tcToolSettings',JSON.stringify(s)); }
        function loadSettings(){ try{const s=JSON.parse(localStorage.getItem('tcToolSettings')||'{}'); if(s.h!=null)h_in.value=s.h; if(s.m!=null)m_in.value=s.m; if(s.s!=null)s_in.value=s.s; if(s.f!=null)f_in.value=s.f; if(s.source)sourceFormatSelect.value=s.source; if(s.target)targetFormatSelect.value=s.target;}catch(_){} }
        function timecodeToFrames(h,m,s,f,fmt){ const{timeBase,isDf}=fmt; let total=(h*3600+m*60+s)*timeBase+f; if(isDf){ const tm=h*60+m; const drop=2*(tm-Math.floor(tm/10)); total-=drop; } return total; }
        function framesToTimecode(total,fmt){ const{timeBase,isDf}=fmt; let fc=Math.round(total); if(isDf){ const d=2, fpm=timeBase*60, fp10m=fpm*10-d*9, n10m=Math.floor(fc/fp10m), rem=fc%fp10m; let dropAmt=d*9*n10m; if(rem>d) dropAmt+=d*Math.floor((rem-d)/(fpm-d)); fc+=dropAmt; } const ff=fc%timeBase, ts=Math.floor(fc/timeBase), ss=ts%60, mm=Math.floor(ts/60)%60, hh=Math.floor(ts/3600); return{hh,mm,ss,ff}; }
        function handleConversion(){ const sf=formats[sourceFormatSelect.value], hh=clamp(parseInt(h_in.value,10)||0,0,99), mm=clamp(parseInt(m_in.value,10)||0,0,59), ss=clamp(parseInt(s_in.value,10)||0,0,59), ff=clamp(parseInt(f_in.value,10)||0,0,sf.timeBase-1); const tf=formats[targetFormatSelect.value]; let sframes=timecodeToFrames(hh,mm,ss,ff,sf), tframes=sframes; if(sf.rate!==tf.rate) tframes=sframes*(tf.rate/sf.rate); const r=framesToTimecode(tframes,tf), sep=tf.isDf?';':':'; resultTitle.textContent=tf.name; resultTimecode.textContent=`${pad2(r.hh)}:${pad2(r.mm)}:${pad2(r.ss)}${sep}${pad2(r.ff)}`; const tsec=(r.hh*3600)+(r.mm*60)+r.ss+(r.ff/tf.timeBase), tr=Math.round(tframes); extraInfo.textContent=`(${tsec.toFixed(3)} 秒 / ${tr} F)`; resultWrapper.classList.remove('hidden'); saveSettings(); }
        function copyResult(){ const t=resultTimecode.textContent; if(!t)return; navigator.clipboard.writeText(t).then(()=>{ copyFeedback.textContent='コピーしました！'; setTimeout(()=>{copyFeedback.textContent=''},1500); }); }
        sourceFormatSelect.addEventListener('change',()=>{updateSourceUI();handleConversion();}); targetFormatSelect.addEventListener('change',handleConversion); convertBtn.addEventListener('click',handleConversion); copyBtn.addEventListener('click',copyResult); clearBtn.addEventListener('click',()=>{timeInputs.forEach(i=>i.value=''); resultWrapper.classList.add('hidden'); localStorage.removeItem('tcToolSettings');}); timeInputs.forEach(i=>{ i.addEventListener('input',(e)=>{if(e.target.value.length>2)e.target.value=e.target.value.slice(-2);handleConversion();}); i.addEventListener('keydown',(e)=>{if(e.key==='Enter'){e.preventDefault();handleConversion();}}); i.addEventListener('blur',formatInputOnBlur); });
        loadSettings(); updateSourceUI(); if([h_in.value,m_in.value,s_in.value,f_in.value].some(v=>v&&v!==''))handleConversion();
    }

    function setupSimpleCalculator() {
        const display = document.getElementById('calc-display'), history = document.getElementById('calc-history'), editToggle = document.getElementById('edit-toggle'), editCancel = document.getElementById('edit-cancel'), editError  = document.getElementById('edit-error'), simpleContainer = document.getElementById('simple-calculator-container');
        const TIME_TOKEN_REGEX = /^\d{1,3}(:\d{1,2}){0,2}$/; let currentInput = '', currentExpression = '', justCalculated = false, editing = false, exprBackup = '';
        function padTimeToken(token) { const parts = token.split(':').map(p => p || '0'); if (parts.length === 1) return String(Number(parts[0])); if (parts.length === 2) return `${String(Number(parts[0]))}:${String(Number(parts[1])).padStart(2, '0')}`; if (parts.length === 3) return `${String(Number(parts[0]))}:${String(Number(parts[1])).padStart(2, '0')}:${String(Number(parts[2])).padStart(2, '0')}`; return token; }
        function timeToSeconds(timeStr) { const parts = timeStr.split(':').map(n => Number(n || 0)); let h = 0, m = 0, s = 0; if (parts.length === 3) [h, m, s] = parts; else if (parts.length === 2) [m, s] = parts; else if (parts.length === 1) [s] = parts; return h * 3600 + m * 60 + s; }
        function secondsToTime(sec) { const sign = sec < 0 ? '-' : ''; sec = Math.abs(sec); const h = String(Math.floor(sec / 3600)).padStart(2, '0'), m = String(Math.floor((sec % 3600) / 60)).padStart(2, '0'), s = String(sec % 60).padStart(2, '0'); return `${sign}${h}:${m}:${s}`; }
        function normalizeExpression(str) { return str.replace(/[＋﹢]/g, '+').replace(/[－﹣–—−]/g, '-').replace(/[：∶︰]/g, ':').replace(/　/g, ' ').replace(/([+\-])/g, ' $1 ').replace(/\s+/g, ' ').trim().split(' ').map(tok => (TIME_TOKEN_REGEX.test(tok) ? padTimeToken(tok) : tok)).join(' '); }
        function validateTimeToken(token) { if (!TIME_TOKEN_REGEX.test(token)) return { ok: false, msg: `書式不正` }; const parts = token.split(':').map(p => Number(p || 0)); if (parts.length === 2 && parts[1] > 59) return { ok: false, msg: `秒不正` }; if (parts.length === 3) { if (parts[1] > 59) return { ok: false, msg: `分不正` }; if (parts[2] > 59) return { ok: false, msg: `秒不正` }; } return { ok: true, msg: '' }; }
        function validateExpression(str) { const norm = normalizeExpression(str); if (norm === '') return { ok: true, normalized: '', msg: '' }; const tokens = norm.split(' '); if (tokens.length % 2 === 0) return { ok: false, normalized: norm, msg: '演算子末尾' }; for (let i = 0; i < tokens.length; i++) { if (i % 2 === 0) { const v = validateTimeToken(tokens[i]); if (!v.ok) return { ok: false, normalized: norm, msg: v.msg }; } else if (!(tokens[i] === '+' || tokens[i] === '-')) { return { ok: false, normalized: norm, msg: `演算子エラー` }; } } return { ok: true, normalized: norm, msg: '' }; }
        function computeFromExpression(exprStr) { const tokens = exprStr.trim().split(/\s+/); let total = timeToSeconds(tokens[0] || '0'); for (let i = 1; i < tokens.length; i += 2) { const op = tokens[i], val = timeToSeconds(tokens[i + 1] || '0'); if (op === '+') total += val; if (op === '-') total -= val; } return total; }
        function updateDisplay() { display.textContent = currentInput || '00:00:00'; history.textContent = currentExpression; }
        function appendNumber(num) { if (editing) return; editError.textContent = ''; if (justCalculated) { currentInput = ''; currentExpression = ''; justCalculated = false; } const next = currentInput + num; if (!/^\d{0,3}(:\d{0,2}){0,2}$/.test(next)) { editError.textContent = '桁数上限'; return; } currentInput = next; updateDisplay(); }
        function appendColon() { if (editing) return; editError.textContent = ''; const count = (currentInput.match(/:/g) || []).length; if (count < 2) { if (currentInput === '' && count === 0) currentInput = '0:'; else currentInput += ':'; updateDisplay(); } }
        function appendOperator(op) { if (editing) return; if (justCalculated && !currentInput) { currentExpression = display.textContent + ' ' + op + ' '; justCalculated = false; updateDisplay(); return; } if (!currentInput) return; const v = validateTimeToken(currentInput); if (!v.ok) { editError.textContent = v.msg; return; } editError.textContent = ''; currentExpression += padTimeToken(currentInput) + ' ' + op + ' '; currentInput = ''; updateDisplay(); }
        function calculateResult() { if (editing) return tryApplyEdit(); if (currentInput) { const v = validateTimeToken(currentInput); if (!v.ok) { editError.textContent = v.msg; return; } } let expr = currentExpression; if (currentInput) expr += padTimeToken(currentInput); expr = normalizeExpression(expr); if (!expr) return; const v = validateExpression(expr); if (!v.ok) { editError.textContent = v.msg; return; } const total = computeFromExpression(v.normalized); const resultStr = secondsToTime(total); history.textContent = v.normalized + ' = ' + resultStr; display.textContent = resultStr; currentExpression = v.normalized + ' '; currentInput = ''; justCalculated = true; editError.textContent = ''; }
        function clearAll() { if (editing) cancelEdit(); currentInput = ''; currentExpression = ''; justCalculated = false; editError.textContent = ''; updateDisplay(); }
        function backspaceOne() { if (editing) return; editError.textContent = ''; if (currentInput) { currentInput = currentInput.slice(0, -1); updateDisplay(); } }
        function setEditing(on) { editing = on; if (on) { exprBackup = history.textContent; history.contentEditable = true; history.classList.add('bg-white', 'dark:bg-gray-700', 'border', 'border-blue-400', 'rounded', 'px-2', 'py-1'); history.focus(); editToggle.textContent = '適用'; editToggle.classList.replace('bg-blue-200', 'bg-green-200'); editToggle.classList.replace('text-blue-800', 'text-green-800'); editToggle.classList.replace('dark:bg-blue-900/50', 'dark:bg-green-900/50'); editToggle.classList.replace('dark:text-blue-300', 'dark:text-green-300'); editCancel.classList.remove('hidden'); editError.textContent = ''; } else { history.contentEditable = false; history.classList.remove('bg-white', 'dark:bg-gray-700', 'border', 'border-blue-400', 'rounded', 'px-2', 'py-1'); editToggle.textContent = '編集'; editToggle.classList.replace('bg-green-200', 'bg-blue-200'); editToggle.classList.replace('text-green-800', 'text-blue-800'); editToggle.classList.replace('dark:bg-green-900/50', 'dark:bg-blue-900/50'); editToggle.classList.replace('dark:text-green-300', 'dark:text-blue-300'); editCancel.classList.add('hidden'); } }
        function tryApplyEdit() { const raw = history.textContent; let exprPart = raw; if (raw.includes('=')) { exprPart = raw.split('=')[0]; } const v = validateExpression(exprPart); if (!v.ok) { editError.textContent = v.msg; return; } currentExpression = v.normalized + ' '; currentInput = ''; justCalculated = false; setEditing(false); calculateResult(); }
        function cancelEdit() { history.textContent = exprBackup; setEditing(false); editError.textContent = ''; }

        document.querySelectorAll('#simple-calculator-container [data-num]').forEach(btn => btn.addEventListener('click', () => appendNumber(btn.dataset.num)));
        document.getElementById('colon-btn').addEventListener('click', appendColon);
        document.querySelectorAll('#simple-calculator-container [data-op]').forEach(btn => btn.addEventListener('click', () => appendOperator(btn.dataset.op)));
        document.getElementById('equal-btn').addEventListener('click', calculateResult);
        document.getElementById('clear-btn').addEventListener('click', clearAll);
        document.getElementById('backspace-btn').addEventListener('click', backspaceOne);
        editToggle.addEventListener('click', () => { if (!editing) { history.textContent = currentExpression.trim(); setEditing(true); } else { tryApplyEdit(); } });
        editCancel.addEventListener('click', cancelEdit);
        history.addEventListener('keydown', (e) => { if (!editing) return; if (e.key === 'Enter') { e.preventDefault(); tryApplyEdit(); } if (e.key === 'Escape') { e.preventDefault(); cancelEdit(); } });
        document.addEventListener('keydown', (e) => { if (simpleContainer.classList.contains('hidden')) return; if (e.target.closest('input, textarea, [contenteditable="true"]')) return; if (editing) return; if (e.key >= '0' && e.key <= '9') { appendNumber(e.key); e.preventDefault(); } else if (e.key === ':' || e.key === ';' || e.key === '.') { appendColon(); e.preventDefault(); } else if (e.key === '+') { appendOperator('+'); e.preventDefault(); } else if (e.key === '-') { appendOperator('-'); e.preventDefault(); } else if (e.key === 'Enter' || e.key === '=') { calculateResult(); e.preventDefault(); } else if (e.key === 'Backspace' || e.key === 'Delete') { backspaceOne(); e.preventDefault(); } else if (e.key === 'Escape' || e.key.toLowerCase() === 'c') { clearAll(); e.preventDefault(); } });
        updateDisplay();
    }


   // =======================================================
    // ▼▼▼ 6. Ｑシート風尺計算モード（高機能エディタ版・TB時刻配置修正版） ▼▼▼
    // =======================================================
    function setupShakuCalculator() {
        const STORAGE_KEY = 'qsheet_editor_v16'; // バージョンアップ
        
        // Elements
        const container = document.getElementById('ladder-rows-container');
        const addRowBtn = document.getElementById('editor-add-row-btn');
        const printBtn = document.getElementById('editor-print-btn');
        const resetBtn = document.getElementById('editor-reset-btn');
        const startTcInput = document.getElementById('editor-start-tc');
        const titleInput = document.getElementById('editor-title');
        
        // Print Sync Elements
        const printTitleDisplay = document.getElementById('print-title-display');
        const printDateDisplay = document.getElementById('print-date-display');

        // 状態管理
        let rowsData = []; 

        // --- 時間計算ヘルパー ---
        function timeToSec(h, m, s) { return (parseInt(h)||0)*3600 + (parseInt(m)||0)*60 + (parseInt(s)||0); }
        function secToTime(totalSec) {
            const h = Math.floor(totalSec / 3600);
            const m = Math.floor((totalSec % 3600) / 60);
            const s = totalSec % 60;
            return { h, m, s };
        }
        function formatTimeCode(sec) {
            const t = secToTime(sec);
            return `${String(t.h).padStart(2,'0')}°${String(t.m).padStart(2,'0')}' ${String(t.s).padStart(2,'0')}"`;
        }
        // 生数字 (010000) に変換
        function formatRawTime(sec) {
             const t = secToTime(sec);
             return `${String(t.h).padStart(2,'0')}${String(t.m).padStart(2,'0')}${String(t.s).padStart(2,'0')}`;
        }
        
        // 文字列パース
        function parseTimeInput(val) {
            val = val.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
            const cleanVal = val.replace(/[^0-9]/g, '');
            let h=0, m=0, s=0;
            
            if (val.match(/[:：°'"’”]/)) {
                const parts = val.split(/[:：°'"’”\s]+/).filter(v=>v!=="").map(p => parseInt(p)||0);
                if(parts.length>=3){ h=parts[0]; m=parts[1]; s=parts[2]; }
                else if(parts.length===2){ m=parts[0]; s=parts[1]; }
                else if(parts.length===1){ h=parts[0]; }
            } else {
                if (cleanVal.length >= 5) { 
                     const pad = cleanVal.padStart(6, '0');
                     h = parseInt(pad.slice(0,2));
                     m = parseInt(pad.slice(2,4));
                     s = parseInt(pad.slice(4,6));
                } else if (cleanVal.length >= 3) { 
                     const pad = cleanVal.padStart(4, '0');
                     m = parseInt(pad.slice(0,2));
                     s = parseInt(pad.slice(2,4));
                } else { 
                     s = parseInt(cleanVal)||0;
                }
            }
            return timeToSec(h,m,s);
        }

        // --- 状態の保存と読み込み ---
        function saveState() {
            const startTc = startTcInput.value;
            const title = titleInput.value;
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ startTc, title, rows: rowsData }));
            updatePrintHeader();
        }

        function loadState() {
            try {
                const json = localStorage.getItem(STORAGE_KEY);
                if (!json) return false;
                const data = JSON.parse(json);
                startTcInput.value = data.startTc || "01:00:00";
                titleInput.value = data.title || "";
                rowsData = data.rows || [];
                if (rowsData.length === 0) addRowData(); 
                renderAll();
                return true;
            } catch(e) { return false; }
        }

        function updatePrintHeader() {
            printTitleDisplay.textContent = titleInput.value;
            const d = new Date();
            printDateDisplay.textContent = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
        }

        // --- データ操作 ---
        function addRowData() {
            rowsData.push({
                id: Date.now() + Math.random(),
                content: "",
                h: 0, m: 0, s: 0,
                tb: { enabled: false, s: 10 },
                barEnabled: true 
            });
            renderAll();
            saveState();
        }

        function deleteRow(index) {
            rowsData.splice(index, 1);
            renderAll();
            saveState();
        }

        // --- 描画とイベント ---
        function renderAll() {
            container.innerHTML = '';
            let currentTotalSec = parseTimeInput(startTcInput.value);

            rowsData.forEach((row, index) => {
                if (row.barEnabled === undefined) row.barEnabled = true;

                const rowDurSec = timeToSec(row.h, row.m, row.s);
                
                // ★重要：この行の開始時刻を定数として保存
                const thisRowStartSec = currentTotalSec;
                const rowEndSec = thisRowStartSec + rowDurSec;

                // --- 提供ベース計算 ---
                const tbDur = (row.tb && row.tb.enabled) ? timeToSec(0, 0, row.tb.s || 0) : 0;
                
                // 判定：TB開始がロール開始と一致しているか
                const isTbStartMatch = (row.tb && row.tb.enabled && (row.tb.offset || 0) <= 0.1);

                // 判定：TB終了がロール終了と一致しているか
                const isTbEndMatch = (row.tb && row.tb.enabled && Math.abs(((row.tb.offset || 0) + tbDur) - rowDurSec) <= 0.1);

                // 判定：前の行のTB終了が、この行の開始と一致しているか
                let isPrevTbEndMatch = false;
                let prevTbEndSec = 0;
                if (index > 0) {
                    const prevRow = rowsData[index - 1];
                    if (prevRow.tb && prevRow.tb.enabled) {
                        const prevRowStart = thisRowStartSec - timeToSec(prevRow.h, prevRow.m, prevRow.s);
                        const prevTbDur = timeToSec(0, 0, prevRow.tb.s || 0);
                        const prevTbEnd = prevRowStart + (prevRow.tb.offset || 0) + prevTbDur;
                        
                        if (Math.abs(prevTbEnd - thisRowStartSec) <= 0.1) {
                            isPrevTbEndMatch = true;
                            prevTbEndSec = prevTbEnd;
                        }
                    }
                }

                // --- DOM生成 ---
                const div = document.createElement('div');
                div.className = 'ladder-row';
                // div.setAttribute('draggable', 'true'); // 削除: ドラッグ無効化
                div.dataset.index = index;

                // ★ 左側のメイン時刻欄の生成（横線を追加）
                let mainInputHtml = "";
                let tbLabelHtml = "";

                if (isTbStartMatch) {
                    // パターン1: TB開始と一致（緑色入力欄 + 緑線）
                    const tbStart = thisRowStartSec + (row.tb.offset || 0);
                    mainInputHtml = `
                        <input type="text" class="time-input-display is-tb-match tb-start-swap" value="${formatTimeCode(tbStart)}" data-raw="${formatRawTime(tbStart)}" inputmode="numeric">
                        <div class="tb-connector-line main-connector-line line-green"></div>`;
                    tbLabelHtml = `<div class="tb-label-overlay">提供ベース</div>`;

                } else if (isPrevTbEndMatch) {
                    // パターン2: 前TB終了と一致（緑色入力欄 + 緑線）
                    mainInputHtml = `
                        <input type="text" class="time-input-display is-tb-match tb-prev-end-swap" value="${formatTimeCode(prevTbEndSec)}" data-raw="${formatRawTime(prevTbEndSec)}" inputmode="numeric">
                        <div class="tb-connector-line main-connector-line line-green"></div>`;
                    
                } else {
                    // パターン3: 通常の本編時刻（黒色入力欄 + 黒線）
                    mainInputHtml = `
                        <input type="text" class="time-input-display row-start-tc" value="${formatTimeCode(thisRowStartSec)}" data-raw="${formatRawTime(thisRowStartSec)}" inputmode="numeric">
                        <div class="tb-connector-line main-connector-line"></div>`;
                }


                // --- 右側(フロートTB)のHTML生成 ---
                let tbTimeHtml = ""; 
                let tbInputHtml = ""; 

                if (row.tb && row.tb.enabled) {
                     const offsetVal = row.tb.offset || 0;
                     if (offsetVal < 0) row.tb.offset = 0;
                     if (offsetVal + tbDur > rowDurSec) row.tb.offset = Math.max(0, rowDurSec - tbDur);
                     
                     let tbStart = thisRowStartSec + row.tb.offset;
                     let tbEnd = tbStart + tbDur;

                     let posClass = "pos-middle";
                     if (row.tb.offset <= 1) posClass = "pos-head";
                     else if (Math.abs(row.tb.offset + tbDur - rowDurSec) <= 1) posClass = "pos-tail";

                     // フロート表示は常に「提供ベース」なので line-green クラスをつける
                     const startInputHtml = isTbStartMatch ? '' : `
                        <div class="tb-time-row-inner">
                            <span class="tb-float-label">提供ベース</span>
                            <input type="text" class="tb-time-input tb-start-tc" value="${formatTimeCode(tbStart)}" data-raw="${formatRawTime(tbStart)}" inputmode="numeric">
                            <div class="tb-connector-line line-green"></div>
                        </div>
                     `;

                     const endInputHtml = isTbEndMatch ? '' : `
                        <div class="tb-time-row-inner">
                            <input type="text" class="tb-time-input tb-end-tc" value="${formatTimeCode(tbEnd)}" data-raw="${formatRawTime(tbEnd)}" inputmode="numeric">
                            <div class="tb-connector-line line-green"></div>
                        </div>
                     `;

                     if (startInputHtml || endInputHtml) {
                         tbTimeHtml = `
                            <div class="tb-time-group ${posClass}">
                                 ${startInputHtml}
                                 ${endInputHtml}
                            </div>
                         `;
                     }

                     tbInputHtml = `
                        <div class="tb-wrapper ${posClass}">
                            <div class="tb-input-row">
                                <span class="tb-label">提供ベース:</span>
                                <input type="number" class="dur-input tb-dur-s" value="${row.tb.s||0}" placeholder="秒">
                                <span class="tb-text text-xs mr-2">秒</span>
                                <button class="tb-remove-btn ml-2 text-gray-400 hover:text-red-500" title="削除">×</button>
                            </div>
                        </div>
                     `;
                } else {
                    tbInputHtml = `
                        <div class="tb-add-btn">+ 提供ベース</div>
                    `;
                }

                div.innerHTML = `
                    <div class="ladder-time-box">
                        ${tbLabelHtml}
                        ${mainInputHtml} 
                        ${tbTimeHtml} 
                    </div>

                    <div class="visual-bar-container">
                        <div class="visual-bar ${row.barEnabled ? '' : 'hidden'}"></div>
                    </div>

                    <div class="ladder-content">
                        <div class="content-lane-main">
                            <div class="content-row-main">
                                <input type="text" class="content-input" value="${row.content}" placeholder="内容 (R1, CM...)">
                            </div>
                            <div class="row-controls">
                                 <span class="drag-handle text-gray-400 hover:text-gray-600 cursor-grab mr-2 pt-1" title="並び替え">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
                                    </svg>
                                 </span>
                                 <button class="delete-btn p-1 bg-red-100 dark:bg-red-900 rounded text-red-500 hover:text-red-700">🗑 削除</button>
                                 <button class="toggle-bar-btn ${row.barEnabled ? 'active' : 'inactive'}">
                                    ${row.barEnabled ? '❚ 帯ON' : '❚ 帯OFF'}
                                 </button>
                            </div>
                        </div>
                        <div class="content-lane-sub">
                            ${tbInputHtml}
                        </div>
                    </div>

                    <div class="ladder-duration-box">
                        <div class="duration-input-group">
                            <span class="text-xs mr-1 font-bold text-gray-400">DUR:</span>
                            <input type="number" class="dur-input row-m" value="${row.m||0}" placeholder="M">
                            <span>:</span>
                            <input type="number" class="dur-input row-s" value="${row.s||0}" placeholder="S">
                        </div>
                    </div>
                `;

                container.appendChild(div);

                // --- イベントリスナー設定 ---
                const setupTimeInput = (inputEl, callback) => {
                    if(!inputEl) return;
                    inputEl.addEventListener('focus', () => {
                        inputEl.value = inputEl.dataset.raw;
                        inputEl.select();
                    });
                    inputEl.addEventListener('blur', () => {
                        const val = inputEl.value;
                        const sec = parseTimeInput(val);
                        inputEl.value = formatTimeCode(sec);
                        inputEl.dataset.raw = formatRawTime(sec);
                        if (callback) callback(sec);
                    });
                    inputEl.addEventListener('keydown', (e) => {
                        if(e.key === 'Enter') inputEl.blur();
                    });
                    inputEl.addEventListener('mousedown', (e) => e.stopPropagation());
                };

                const contentIn = div.querySelector('.content-input');
                const mIn = div.querySelector('.row-m');
                const sIn = div.querySelector('.row-s');
                
                const rowStartInput = div.querySelector('.row-start-tc');
                const tbStartSwapInput = div.querySelector('.tb-start-swap');
                const tbPrevEndSwapInput = div.querySelector('.tb-prev-end-swap');

                const tbAddBtn = div.querySelector('.tb-add-btn');
                const tbRemoveBtn = div.querySelector('.tb-remove-btn');
                const tbDurInput = div.querySelector('.tb-dur-s');
                const tbStartInput = div.querySelector('.tb-start-tc');
                const tbEndInput = div.querySelector('.tb-end-tc');
                const toggleBarBtn = div.querySelector('.toggle-bar-btn');

                // --- 基本リスナー ---
                toggleBarBtn.addEventListener('click', () => {
                    row.barEnabled = !row.barEnabled; saveState(); renderAll(); 
                });
                if(tbAddBtn) tbAddBtn.addEventListener('click', () => { 
                    if(!row.tb) row.tb = { s:10 }; 
                    row.tb.enabled = true; 
                    const cDur = timeToSec(row.h, row.m, row.s);
                    row.tb.offset = Math.max(0, cDur - 10);
                    renderAll(); saveState(); 
                });
                if(tbRemoveBtn) tbRemoveBtn.addEventListener('click', () => { 
                    row.tb.enabled = false; renderAll(); saveState(); 
                });

                // DUR入力欄エンター対応
                [contentIn, mIn, sIn].forEach(el => {
                    if(!el) return;
                    el.addEventListener('input', () => {
                         row.content = contentIn.value;
                         row.h = 0; row.m = parseInt(mIn.value)||0; row.s = parseInt(sIn.value)||0;
                         saveState();
                    });
                    el.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') el.blur();
                    });
                    el.addEventListener('blur', renderAll);
                    el.addEventListener('mousedown', (e) => e.stopPropagation());
                });

                if(tbDurInput) {
                    tbDurInput.addEventListener('input', () => {
                        row.tb.s = parseInt(tbDurInput.value)||0; saveState();
                    });
                    tbDurInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') tbDurInput.blur();
                    });
                    tbDurInput.addEventListener('blur', renderAll);
                    tbDurInput.addEventListener('mousedown', (e) => e.stopPropagation());
                }

                // --- 時刻操作リスナー ---
                
                // 1. 通常の本編開始時刻
                if (rowStartInput) {
                    setupTimeInput(rowStartInput, (newSec) => {
                        if (index === 0) {
                            startTcInput.value = formatRawTime(newSec);
                        } else {
                            const prevRow = rowsData[index - 1];
                            const prevStartSec = thisRowStartSec - timeToSec(prevRow.h, prevRow.m, prevRow.s);
                            let newPrevDur = newSec - prevStartSec;
                            if(newPrevDur < 0) newPrevDur = 0;
                            const t = secToTime(newPrevDur);
                            prevRow.h = t.h; prevRow.m = t.m; prevRow.s = t.s;
                        }
                        renderAll(); saveState();
                    });
                }

                // 2. 統合されたTB開始時刻
                if (tbStartSwapInput) {
                    setupTimeInput(tbStartSwapInput, (newSec) => {
                        let newOffset = newSec - thisRowStartSec;
                        if (newOffset < 0) newOffset = 0;
                        row.tb.offset = newOffset;
                        renderAll(); saveState();
                    });
                }

                // 3. 統合された前TB終了時刻
                if (tbPrevEndSwapInput) {
                    setupTimeInput(tbPrevEndSwapInput, (newSec) => {
                        const prevRow = rowsData[index - 1];
                        const prevRowStart = thisRowStartSec - timeToSec(prevRow.h, prevRow.m, prevRow.s);
                        const prevTbStart = prevRowStart + (prevRow.tb.offset || 0);
                        let newTbDur = newSec - prevTbStart;
                        if (newTbDur < 0) newTbDur = 0;
                        prevRow.tb.s = newTbDur;
                        renderAll(); saveState();
                    });
                }

                // 4. フロートTB開始/終了
                if (tbStartInput) {
                    setupTimeInput(tbStartInput, (newSec) => {
                        row.tb.offset = newSec - thisRowStartSec;
                        renderAll(); saveState();
                    });
                }
                if (tbEndInput) {
                    setupTimeInput(tbEndInput, (newSec) => {
                        const currentTbStart = thisRowStartSec + (row.tb.offset || 0);
                        let newDur = newSec - currentTbStart;
                        if (newDur < 0) newDur = 0;
                        row.tb.s = newDur;
                        renderAll(); saveState();
                    });
                }

                div.querySelector('.delete-btn').addEventListener('click', () => deleteRow(index));
                // ドラッグ関連のイベントリスナー（dragstart, dragend, dragover）は全て削除しました

                currentTotalSec += rowDurSec;
            });

            // --- 終了線と終了時刻エリア ---
            const oldBottom = document.querySelector('.ladder-bottom-area');
            if(oldBottom) oldBottom.remove();
            
            // 最後の行のTB終了チェック
            let isLastRowTbEndMatch = false;
            let lastTbEndSec = 0;
            if (rowsData.length > 0) {
                const lastRow = rowsData[rowsData.length - 1];
                if (lastRow.tb && lastRow.tb.enabled) {
                    const lastRowDur = timeToSec(lastRow.h, lastRow.m, lastRow.s);
                    const lastTbDur = timeToSec(0, 0, lastRow.tb.s || 0);
                    if (Math.abs(((lastRow.tb.offset || 0) + lastTbDur) - lastRowDur) <= 0.1) {
                        isLastRowTbEndMatch = true;
                        const lastRowStart = currentTotalSec - lastRowDur;
                        lastTbEndSec = lastRowStart + (lastRow.tb.offset || 0) + lastTbDur;
                    }
                }
            }
            
            // ★ 最後尾の入力欄にも線を追加
            let bottomInputHtml = "";
            if (isLastRowTbEndMatch) {
                // 提供ベース終了と一致（緑線）
                bottomInputHtml = `
                    <input type="text" id="total-end-tc" class="end-time-input is-tb-match tb-last-end-swap" value="${formatTimeCode(lastTbEndSec)}" data-raw="${formatRawTime(lastTbEndSec)}" inputmode="numeric">
                    <div class="tb-connector-line main-connector-line line-green" style="right: -130px; top: 0;"></div>
                `;
            } else {
                // 通常終了（黒線）
                bottomInputHtml = `
                    <input type="text" id="total-end-tc" class="end-time-input" value="${formatTimeCode(currentTotalSec)}" data-raw="${formatRawTime(currentTotalSec)}" inputmode="numeric">
                    <div class="tb-connector-line main-connector-line" style="right: -130px; top: 0;"></div>
                `;
            }

            const bottomDiv = document.createElement('div');
            bottomDiv.className = 'ladder-bottom-area';
            bottomDiv.innerHTML = bottomInputHtml;
            
            container.parentNode.insertBefore(bottomDiv, container.nextSibling);

            const setupEndTimeInput = (inputEl, callback) => {
                 if(!inputEl) return;
                 inputEl.addEventListener('focus', () => { inputEl.value = inputEl.dataset.raw; inputEl.select(); });
                 inputEl.addEventListener('blur', () => {
                     const sec = parseTimeInput(inputEl.value);
                     inputEl.value = formatTimeCode(sec);
                     inputEl.dataset.raw = formatRawTime(sec);
                     if(callback) callback(sec);
                 });
                 inputEl.addEventListener('keydown', (e) => { if(e.key==='Enter') inputEl.blur(); });
                 inputEl.addEventListener('mousedown', (e) => e.stopPropagation());
            };

            const endTcIn = document.getElementById('total-end-tc');
            if (endTcIn) {
                setupEndTimeInput(endTcIn, (newEndSec) => {
                    if (rowsData.length > 0) {
                        const lastRow = rowsData[rowsData.length - 1];
                        const lastRowStart = currentTotalSec - timeToSec(lastRow.h, lastRow.m, lastRow.s);
                        
                        if (endTcIn.classList.contains('tb-last-end-swap')) {
                            const lastTbStart = lastRowStart + (lastRow.tb.offset || 0);
                            let newTbDur = newEndSec - lastTbStart;
                            if (newTbDur < 0) newTbDur = 0;
                            lastRow.tb.s = newTbDur;
                        } else {
                            let newDur = newEndSec - lastRowStart;
                            if(newDur < 0) newDur = 0;
                            const t = secToTime(newDur);
                            lastRow.h = t.h; lastRow.m = t.m; lastRow.s = t.s;
                        }
                        renderAll(); saveState();
                    }
                });
            }
        }

        // 保存データがない場合の初期化処理
        if (!loadState()) {
            startTcInput.value = "00:58:15";
            rowsData = [];
            
            // 1行目: CB (1分30秒)
            rowsData.push({
                id: Date.now() + Math.random(),
                content: "CB",
                h: 0, m: 1, s: 30,
                tb: { enabled: false, s: 10 },
                barEnabled: false 
            });

            // 2行目: クレジット (15秒)
            rowsData.push({
                id: Date.now() + Math.random() + 1,
                content: "クレジット",
                h: 0, m: 0, s: 15,
                tb: { enabled: false, s: 10 },
                barEnabled: false 
            });

            renderAll();
            saveState();
        }

        addRowBtn.addEventListener('click', addRowData);
        resetBtn.addEventListener('click', () => {
            if(confirm("全てリセットしますか？")) {
                localStorage.removeItem(STORAGE_KEY);
                // 配列を空にする
                rowsData = [];
                // 開始TCを 00:58:15 に設定
                startTcInput.value = "00:58:15"; 
                titleInput.value = "";
                
                // 1行目: CB (1分30秒)
                rowsData.push({
                    id: Date.now() + Math.random(),
                    content: "CB",
                    h: 0, m: 1, s: 30,
                    tb: { enabled: false, s: 10 },
                    barEnabled: false 
                });

                // 2行目: クレジット (15秒)
                rowsData.push({
                    id: Date.now() + Math.random() + 1,
                    content: "クレジット",
                    h: 0, m: 0, s: 15,
                    tb: { enabled: false, s: 10 },
                    barEnabled: false 
                });

                renderAll();
                saveState();
            }
        });
        startTcInput.addEventListener('focus', () => {
             const val = startTcInput.value.replace(/[^0-9]/g, '');
             startTcInput.value = val;
             startTcInput.select();
        });
        startTcInput.addEventListener('blur', () => {
             const sec = parseTimeInput(startTcInput.value);
             const t = secToTime(sec);
             startTcInput.value = `${String(t.h).padStart(2,'0')}:${String(t.m).padStart(2,'0')}:${String(t.s).padStart(2,'0')}`;
             renderAll(); saveState();
        });
        startTcInput.addEventListener('keydown', (e) => { if(e.key==='Enter') startTcInput.blur(); });
        titleInput.addEventListener('input', () => { saveState(); });
        printBtn.addEventListener('click', () => { updatePrintHeader(); window.print(); });

        // ▼ ドラッグ並び替え（SortableJS）導入
        const ladderContainer = document.getElementById("ladder-rows-container");
        new Sortable(ladderContainer, {
            animation: 150,
            handle: ".drag-handle", // ハンドル部分でのみドラッグ可能にする
            ghostClass: "dragging", // ドラッグ中のクラス（CSSでスタイル定義済み）
            onEnd: (evt) => {
                // 配列 rowsData の順番を入れ替える
                const moved = rowsData.splice(evt.oldIndex, 1)[0];
                rowsData.splice(evt.newIndex, 0, moved);
                
                // 保存して再描画（これで時刻計算などが追従します）
                saveState();
                renderAll();
            }
        });
    }
    </script>
</body>
</html>
